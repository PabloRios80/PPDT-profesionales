<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Turnos - IAPOS</title>
    <style>
        /* Estilos consistentes con el resto de la app */
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 20px; background-color: #f0f8ff; }
        .container { background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 30px; max-width: 1200px; margin: auto; }
        .header-banner { background-color: #005A9C; color: white; padding: 15px 30px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; margin: -30px -30px 30px -30px; }
        .header-banner h1 { font-size: 2em; color: white; margin: 0; border: none; }
        .header-banner img { height: 50px; }
        h2 { color: #005A9C; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #e6f7ff; }
        .cancel-btn { background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .cancel-btn:hover { background-color: #c82333; }
        .actions-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .action-button { padding: 10px 20px; border-radius: 5px; text-decoration: none; color: white; font-weight: bold; cursor: pointer; border: none; }
        .btn-green { background-color: #009A44; }
        .btn-gray { background-color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-banner">
                <h1>Panel de Preventivistas</h1>
                <img src="logo_iapos.png" alt="Logo IAPOS">
            </div>
        </header>

        <div class="actions-bar">
            <h2>Turnos Agendados</h2>
            <div>
                <a href="/" target="_blank" class="action-button btn-green">Nuevo Turno</a>
                <button id="logout-btn" class="action-button btn-gray">Salir</button>
            </div>
        </div>

        <table id="turnos-table">
            <thead>
                <tr>
                    <th>Fecha y Hora</th>
                    <th>Apellido y Nombre</th>
                    <th>DNI</th>
                    <th>Email</th>
                    <th>Teléfono</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        // --- INICIO DEL SCRIPT COMPLETO Y CORREGIDO ---

        // 1. Proteger la página
        if (sessionStorage.getItem('preventivista-logueado') !== 'true') {
            window.location.href = 'login.html';
        }

        // 2. Lógica del botón Salir
        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('preventivista-logueado');
            window.location.href = 'index.html';
        });

        // 3. Lógica para cargar y mostrar los turnos (la que habíamos borrado por error)
        document.addEventListener('DOMContentLoaded', async () => {
            const tableBody = document.querySelector('#turnos-table tbody');
            
            try {
                const response = await fetch('/api/admin/turnos');
                const data = await response.json();

                if (data.status === 'success' && data.appointments.length > 0) {
                    let html = '';
                    data.appointments.forEach(turno => {
                        // Formateamos la fecha para que sea más legible
                        const fecha = new Date(turno.fechaInicio).toLocaleString('es-AR', {
                            year: 'numeric', month: '2-digit', day: '2-digit',
                            hour: '2-digit', minute: '2-digit', hour12: false
                        });
                        html += `
                            <tr id="turno-${turno.idEvento.replace(/@/g, '-')}">
                                <td>${fecha} hs</td>
                                <td>${turno.apellido}, ${turno.nombre}</td>
                                <td>${turno.dni}</td>
                                <td>${turno.email || 'No provisto'}</td>
                                <td>${turno.telefono}</td>
                                <td><button class="cancel-btn" data-id="${turno.idEvento}">Anular</button></td>
                            </tr>
                        `;
                    });
                    tableBody.innerHTML = html;
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay turnos agendados.</td></tr>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Error al cargar los turnos.</td></tr>';
            }
        });

        // 4. Lógica para el botón de anular (la que ya funcionaba)
        document.getElementById('turnos-table').addEventListener('click', async (e) => {
            if (e.target.classList.contains('cancel-btn')) {
                const eventId = e.target.dataset.id;
                if (confirm('¿Estás seguro de que quieres anular este turno? Esta acción no se puede deshacer.')) {
                    try {
                        const response = await fetch('/api/cancelar', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ eventId: eventId })
                        });
                        const result = await response.json();
                        if (result.status === 'success') {
                            document.getElementById(`turno-${eventId.replace(/@/g, '-')}`).remove();
                            alert('Turno anulado con éxito.');
                        } else {
                            throw new Error(result.message);
                        }
                    } catch (error) {
                        alert('Error al anular el turno: ' + error.message);
                    }
                }
            }
        });

        // --- FIN DEL SCRIPT COMPLETO ---
    </script>
</body>
</html>