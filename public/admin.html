<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel de Turnos - IAPOS</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos Generales */
        body { font-family: 'Roboto', sans-serif; margin: 0; padding: 20px; background-color: #f0f8ff; }
        .container { background-color: #ffffff; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 30px; max-width: 1200px; margin: auto; }
        h2, h3 { color: #005A9C; }
        .hidden { display: none; }

        /* Encabezado */
        .header-banner { background-color: #005A9C; color: white; padding: 15px 30px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; margin: -30px -30px 30px -30px; }
        .header-banner h1 { font-size: 2em; color: white; margin: 0; border: none; }
        .header-banner img { height: 50px; }

        /* Barra de Acciones y Botones */
        .actions-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .action-button { padding: 10px 20px; border-radius: 5px; text-decoration: none; color: white; font-weight: bold; cursor: pointer; border: none; transition: opacity 0.3s; }
        .action-button:hover { opacity: 0.9; }
        .btn-green { background-color: #009A44; }
        .btn-gray { background-color: #6c757d; }
        .btn-blue { background-color: #005A9C; }

        /* Vistas */
        .vista { display: none; }
        .vista.activa { display: block; }

        /* Vista Tabla de Turnos */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em; }
        th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background-color: #e6f7ff; }
        .cancel-btn { background-color: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; }
        .cancel-btn:hover { background-color: #c82333; }

        /* Vista Nuevo Turno (Estilos de index.html) */
        .calendario { margin-bottom: 20px; }
        .calendario h3 { text-transform: capitalize; color: #005A9C; }
        .calendario table { width: 100%; border-collapse: collapse; }
        .dia-disponible { background-color: #005A9C; color: white; border: none; cursor: pointer; display: inline-block; width: 40px; height: 40px; line-height: 40px; border-radius: 50%; }
        .dia-disponible.seleccionado { background-color: #009A44; }
        .dia-no-disponible { color: #ccc; display: inline-block; width: 40px; height: 40px; line-height: 40px; border-radius: 50%; }
        #titulo-horarios { text-transform: capitalize; color: #333; font-size: 1.1em; margin-bottom: 15px; font-weight: bold; }
        .slots-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .slot-button { background-color: #005A9C; color: white; border: none; padding: 15px 10px; border-radius: 5px; cursor: pointer; font-weight: 700; }
        #formulario-reserva { background-color: #e6f7ff; padding: 20px; border-radius: 8px; margin-top: 20px; }
        #formulario-reserva input { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #formulario-reserva button { background-color: #009A44; color: white; padding: 12px 20px; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
        #mensaje { padding: 15px; margin-top: 20px; border-radius: 5px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        #loading { font-size: 1.2em; color: #005A9C; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-banner">
                <h1>Panel de Preventivistas</h1>
                <img src="logo_iapos.png" alt="Logo IAPOS">
            </div>
        </header>

        <div class="actions-bar">
            <h2>Panel de Control</h2>
            <div>
                <button id="btn-ver-turnos" class="action-button btn-blue">Ver Turnos Agendados</button>
                <button id="btn-nuevo-turno" class="action-button btn-green">Nuevo Turno Manual</button>
                <button id="logout-btn" class="action-button btn-gray">Salir</button>
            </div>
        </div>

        <div id="vista-turnos" class="vista activa">
            <h3>Turnos Agendados</h3>
            <table id="turnos-table">
                <thead>
                    <tr>
                        <th>Fecha y Hora</th>
                        <th>Apellido y Nombre</th>
                        <th>DNI</th>
                        <th>Email</th>
                        <th>Teléfono</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>

        <div id="vista-nuevo-turno" class="vista">
            <h3>Agendar un Nuevo Turno</h3>
            <div id="loading">Cargando turnos disponibles...</div>
            <div id="calendarios-container"></div>
            <div id="horarios-container" class="hidden">
                <hr style="margin: 30px 0;">
                <h3 id="titulo-horarios"></h3>
                <div id="slots-disponibles" class="slots-grid"></div>
            </div>
            <div id="formulario-reserva" class="hidden">
                <hr style="margin: 30px 0;">
                <p id="turno-seleccionado-info" style="font-weight:bold; margin-bottom:15px;"></p>
                <form id="booking-form">
                    <input type="hidden" id="slotId" name="slotId">
                    <input type="text" id="dni" name="dni" placeholder="DNI (buscará datos al salir del campo)" required pattern="\d{7,8}">
                    <input type="text" id="apellido" name="apellido" placeholder="Apellido" required>
                    <input type="text" id="nombre" name="nombre" placeholder="Nombre" required>
                    <input type="email" id="email" name="email" placeholder="Email para confirmación" required>
                    <input type="tel" id="whatsapp" name="whatsapp" placeholder="Teléfono (ej: 3421234567)" required pattern="[0-9]{10}">
                    <button type="submit">Confirmar Turno</button>
                </form>
            </div>
            <div id="mensaje" class="hidden"></div>
        </div>
    </div>

    <script>
        // --- SCRIPT COMPLETO PARA EL PANEL DE ADMINISTRACIÓN ---

        // 1. VERIFICACIÓN DE LOGIN
        if (sessionStorage.getItem('preventivista-logueado') !== 'true') {
            window.location.href = 'login.html';
        }

        // 2. REFERENCIAS A ELEMENTOS DEL DOM
        const btnVerTurnos = document.getElementById('btn-ver-turnos');
        const btnNuevoTurno = document.getElementById('btn-nuevo-turno');
        const vistaTurnos = document.getElementById('vista-turnos');
        const vistaNuevoTurno = document.getElementById('vista-nuevo-turno');
        const logoutBtn = document.getElementById('logout-btn');
        const tableBody = document.querySelector('#turnos-table tbody');
        const loadingDiv = document.getElementById('loading');
        const calendariosContainer = document.getElementById('calendarios-container');
        const horariosContainer = document.getElementById('horarios-container');
        const slotsDisponiblesDiv = document.getElementById('slots-disponibles');
        const formContainer = document.getElementById('formulario-reserva');
        const bookingForm = document.getElementById('booking-form');
        const mensajeDiv = document.getElementById('mensaje');
        let turnosDisponibles = [];

        // 3. LÓGICA DE NAVEGACIÓN ENTRE VISTAS
        btnVerTurnos.addEventListener('click', () => {
            vistaTurnos.classList.add('activa');
            vistaNuevoTurno.classList.remove('activa');
            cargarTurnosAgendados();
        });
        btnNuevoTurno.addEventListener('click', () => {
            vistaTurnos.classList.remove('activa');
            vistaNuevoTurno.classList.add('activa');
        });
        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('preventivista-logueado');
            window.location.href = 'index.html';
        });

        // 4. LÓGICA PARA LA VISTA "VER TURNOS AGENDADOS"
        async function cargarTurnosAgendados() {
            tableBody.innerHTML = '<tr><td colspan="6">Cargando...</td></tr>';
            try {
                const response = await fetch('/api/admin/turnos');
                const data = await response.json();
                if (data.status === 'success' && data.appointments.length > 0) {
                    let html = '';
                    data.appointments.forEach(turno => {
                        const fecha = new Date(turno.fechaInicio).toLocaleString('es-AR', { dateStyle: 'short', timeStyle: 'short' });
                        html += `<tr id="turno-${turno.idEvento.replace(/@/g, '-')}">
                            <td>${fecha} hs</td>
                            <td>${turno.apellido}, ${turno.nombre}</td>
                            <td>${turno.dni}</td>
                            <td>${turno.email || ''}</td>
                            <td>${turno.telefono}</td>
                            <td><button class="cancel-btn" data-id="${turno.idEvento}">Anular</button></td>
                        </tr>`;
                    });
                    tableBody.innerHTML = html;
                } else {
                    tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No hay turnos agendados.</td></tr>';
                }
            } catch (error) {
                tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Error al cargar los turnos.</td></tr>';
            }
        }
        tableBody.addEventListener('click', async (e) => {
            if (e.target.classList.contains('cancel-btn')) {
                const eventId = e.target.dataset.id;
                if (confirm('¿Estás seguro de que quieres anular este turno?')) {
                    const response = await fetch('/api/cancelar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ eventId: eventId })
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        document.getElementById(`turno-${eventId.replace(/@/g, '-')}`).remove();
                        alert('Turno anulado con éxito.');
                    } else { alert('Error al anular el turno: ' + result.message); }
                }
            }
        });

        // 5. LÓGICA PARA LA VISTA "NUEVO TURNO MANUAL"
        function mostrarHorariosPara(fecha) {
            const turnosDelDia = turnosDisponibles.filter(slot => new Date(slot.time).toISOString().startsWith(fecha));
            let html = '';
            const fechaObj = new Date(fecha + 'T00:00:00');
            document.getElementById('titulo-horarios').textContent = fechaObj.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            turnosDelDia.forEach(slot => {
                const horaObj = new Date(slot.time);
                const hora = horaObj.toLocaleTimeString('es-AR', { hour: '2-digit', minute: '2-digit', hour12: false });
                const infoCompleta = `${fechaObj.toLocaleDateString('es-AR', { weekday: 'long', day: 'numeric', month: 'long' })} a las ${hora} hs`;
                html += `<button class="slot-button" data-id="${slot.id}" data-info="${infoCompleta}">${hora}</button>`;
            });
            slotsDisponiblesDiv.innerHTML = html;
            horariosContainer.classList.remove('hidden');
            formContainer.classList.add('hidden');
        }

        async function iniciarTurneraManual() {
            try {
                const response = await fetch('/api/turnos');
                const data = await response.json();
                loadingDiv.classList.add('hidden');
                if (data.status === 'success' && data.slots.length > 0) {
                    turnosDisponibles = data.slots;
                    const diasConTurnos = new Set(turnosDisponibles.map(slot => new Date(slot.time).toISOString().split('T')[0]));
                    calendariosContainer.innerHTML = '';
                    const hoy = new Date();
                    for (let i = 0; i < 2; i++) {
                        const fecha = new Date(hoy.getFullYear(), hoy.getMonth() + i, 1);
                        const mes = fecha.getMonth();
                        const anio = fecha.getFullYear();
                        let calendarioHTML = `<div class="calendario"><h3>${fecha.toLocaleString('es-AR', { month: 'long', year: 'numeric' })}</h3><table><thead><tr><th>Dom</th><th>Lun</th><th>Mar</th><th>Mié</th><th>Jue</th><th>Vie</th><th>Sáb</th></tr></thead><tbody>`;
                        let primerDia = new Date(anio, mes, 1).getDay();
                        let diasEnMes = new Date(anio, mes + 1, 0).getDate();
                        let fechaCelda = 1;
                        for (let j = 0; j < 6; j++) {
                            calendarioHTML += '<tr>';
                            for (let k = 0; k < 7; k++) {
                                if (j === 0 && k < primerDia || fechaCelda > diasEnMes) {
                                    calendarioHTML += '<td></td>';
                                } else {
                                    const fechaCompleta = `${anio}-${String(mes + 1).padStart(2, '0')}-${String(fechaCelda).padStart(2, '0')}`;
                                    if (diasConTurnos.has(fechaCompleta)) {
                                        calendarioHTML += `<td><button class="dia-disponible" data-fecha="${fechaCompleta}">${fechaCelda}</button></td>`;
                                    } else {
                                        calendarioHTML += `<td><span class="dia-no-disponible">${fechaCelda}</span></td>`;
                                    }
                                    fechaCelda++;
                                }
                            }
                            calendarioHTML += '</tr>';
                            if(fechaCelda > diasEnMes) break;
                        }
                        calendarioHTML += '</tbody></table></div>';
                        calendariosContainer.innerHTML += calendarioHTML;
                    }
                } else {
                    calendariosContainer.innerHTML = '<p>No hay turnos disponibles.</p>';
                }
            } catch (error) {
                loadingDiv.textContent = 'Error al cargar la turnera.';
            }
        }
        
        calendariosContainer.addEventListener('click', (e) => {
            if(e.target.classList.contains('dia-disponible')) {
                mostrarHorariosPara(e.target.dataset.fecha);
                document.querySelectorAll('.dia-disponible').forEach(btn => btn.classList.remove('seleccionado'));
                e.target.classList.add('seleccionado');
            }
        });

        slotsDisponiblesDiv.addEventListener('click', (e) => {
            if (e.target.classList.contains('slot-button')) {
                document.getElementById('slotId').value = e.target.dataset.id;
                document.getElementById('turno-seleccionado-info').textContent = `Turno seleccionado: ${e.target.dataset.info}`;
                formContainer.classList.remove('hidden');
                bookingForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
        
        const dniInput = bookingForm.querySelector('#dni');
        dniInput.addEventListener('blur', async () => {
            const dni = dniInput.value.trim();
            if (dni.length >= 7) {
                try {
                    const response = await fetch(`/api/admin/usuario/${dni}`);
                    const result = await response.json();
                    if (result.status === 'success') {
                        bookingForm.querySelector('#nombre').value = result.data.nombre || '';
                        bookingForm.querySelector('#apellido').value = result.data.apellido || '';
                        bookingForm.querySelector('#email').value = result.data.email || '';
                        bookingForm.querySelector('#whatsapp').value = result.data.telefono || '';
                    }
                } catch (error) { console.error("Error buscando DNI:", error); }
            }
        });

        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(bookingForm);
            const data = Object.fromEntries(formData.entries());
            const submitButton = bookingForm.querySelector('button');
            submitButton.disabled = true;
            submitButton.textContent = 'Confirmando...';

            const response = await fetch('/api/reservar', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            formContainer.classList.add('hidden');
            horariosContainer.classList.add('hidden');
            mensajeDiv.classList.remove('hidden');
            if (result.status === 'success') {
                mensajeDiv.className = 'success';
                mensajeDiv.innerHTML = `<h2>¡Turno agendado con éxito!</h2><p>El afiliado recibirá una confirmación por email.</p>`;
                // Resetear el formulario y la vista
                bookingForm.reset();
                iniciarTurneraManual(); 
            } else {
                mensajeDiv.className = 'error';
                mensajeDiv.innerHTML = `<h2>Error al reservar</h2><p>${result.message || 'Error de conexión.'}</p>`;
            }
            submitButton.disabled = false;
            submitButton.textContent = 'Confirmar Turno';
        });

        // --- INICIALIZACIÓN ---
        cargarTurnosAgendados(); // Carga la tabla de turnos por defecto
        iniciarTurneraManual(); // Carga el calendario en segundo plano
    </script>
</body>
</html>